<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Quiz - <%= title %></title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
		<main>
			<div class="error" id="error"></div>

			<div class="quiz-header">
				<div class="student-info">
					Student:
					<strong id="studentName"><%= studentName %></strong>
				</div>
				<div class="timer" id="timer">0s</div>
			</div>

			<div class="question-section">
				<div class="question-text" id="questionText">
					Loading question...
				</div>

				<div class="options" id="optionsContainer">
					<!-- Options will be loaded here -->
				</div>
			</div>

			<button class="submit-btn" id="submitBtn" disabled>
				Select an answer
			</button>

			<div class="loading" id="loading">Submitting your answer...</div>
		</main>

		<script>
			const TIMER_WARNING_SECONDS = 30;
			const studentName = "<%= studentName %>";

			let selectedAnswer = null;
			let startTime = Date.now();
			let timerInterval = null;
			let currentQuestion = null;

			// Clear any existing timer interval
			function clearTimer() {
				if (timerInterval) {
					clearInterval(timerInterval);
					timerInterval = null;
				}
			}

			// Start timer
			function startTimer() {
				clearTimer();

				timerInterval = setInterval(() => {
					const elapsed = Math.floor((Date.now() - startTime) / 1000);
					const timerEl = document.getElementById("timer");
					timerEl.textContent = elapsed + "s";

					// Warning color after threshold
					if (elapsed >= TIMER_WARNING_SECONDS) {
						timerEl.classList.add("warning");
					} else {
						timerEl.classList.remove("warning");
					}
				}, 1000);
			}

			// Load question
			async function loadQuestion() {
				try {
					const response = await fetch("/api/question");
					if (!response.ok) {
						throw new Error(
							`HTTP ${response.status}: ${response.statusText}`
						);
					}

					currentQuestion = await response.json();

					if (!currentQuestion || !currentQuestion.id) {
						throw new Error("Invalid question data received");
					}

					displayQuestion(currentQuestion);
					startTimer();
				} catch (error) {
					showError(
						"Failed to load question. Please refresh the page."
					);
					console.error("Load question error:", error);
				}
			}

			// Display question
			function displayQuestion(question) {
				document.getElementById("questionText").textContent =
					question.questionText;

				const optionsContainer =
					document.getElementById("optionsContainer");
				optionsContainer.innerHTML = "";

				if (
					!Array.isArray(question.options) ||
					question.options.length === 0
				) {
					showError("Question has no options");
					return;
				}

				question.options.forEach((option, index) => {
					const optionEl = document.createElement("div");
					optionEl.className = "option";
					optionEl.innerHTML = `
                    <span class="option-label">${String.fromCharCode(
						65 + index
					)}</span>
                    <span>${option}</span>
                `;

					optionEl.addEventListener("click", () =>
						selectOption(option, optionEl)
					);
					optionsContainer.appendChild(optionEl);
				});
			}

			// Select option
			function selectOption(answer, element) {
				selectedAnswer = answer;

				// Remove selected class
				document.querySelectorAll(".option").forEach(opt => {
					opt.classList.remove("selected");
				});

				// Add selected class
				element.classList.add("selected");

				// Enable submit button
				const submitBtn = document.getElementById("submitBtn");
				submitBtn.disabled = false;
				submitBtn.textContent = "Submit Answer";
			}

			// Submit answer
			async function submitAnswer() {
				if (!selectedAnswer || !currentQuestion) return;

				clearTimer();
				const duration = Math.floor((Date.now() - startTime) / 1000);

				// Show loading
				document.getElementById("submitBtn").style.display = "none";
				document.getElementById("loading").style.display = "block";

				try {
					const response = await fetch("/api/submit", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({
							studentName: studentName,
							questionId: currentQuestion.id,
							answer: selectedAnswer,
							duration: duration,
						}),
					});

					if (!response.ok) {
						throw new Error(
							`HTTP ${response.status}: ${response.statusText}`
						);
					}

					const result = await response.json();

					// Redirect to results/leaderboard
					window.location.href = "/leaderboard";
				} catch (error) {
					showError("Failed to submit answer. Please try again.");
					console.error("Submit error:", error);

					// Restore UI
					document.getElementById("submitBtn").style.display =
						"block";
					document.getElementById("loading").style.display = "none";
					startTimer(); // Restart timer
				}
			}

			// Show error
			function showError(message) {
				if (timerInterval) clearInterval(timerInterval);
				const errorEl = document.getElementById("error");
				errorEl.textContent = message;
				errorEl.style.display = "block";
			}

			// Event listeners
			document
				.getElementById("submitBtn")
				.addEventListener("click", submitAnswer);

			// Cleanup on page unload
			window.addEventListener("beforeunload", clearTimer);
			window.addEventListener("beforeunload", () => {
				if (timerInterval) clearInterval(timerInterval);
			});

			// Load question on page load
			loadQuestion();
		</script>
	</body>
</html>
