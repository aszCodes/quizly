<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Quiz - <%= title %></title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
		<main>
			<div class="error" id="error"></div>

			<div class="quiz-header">
				<div class="student-info">
					Student:
					<strong id="studentName"><%= studentName %></strong>
				</div>
				<div class="timer" id="timer">0s</div>
			</div>

			<div class="question-section">
				<div class="question-text" id="questionText">
					Loading question...
				</div>

				<div class="options" id="optionsContainer">
					<!-- Options will be loaded here -->
				</div>
			</div>

			<button class="submit-btn" id="submitBtn" disabled>
				Select an answer
			</button>

			<div class="loading" id="loading">Submitting your answer...</div>
		</main>

		<script>
			const studentName = "<%= studentName %>";
			let selectedAnswer = null;
			let startTime = Date.now();
			let timerInterval;
			let currentQuestion = null;

			// Start timer
			function startTimer() {
				timerInterval = setInterval(() => {
					const elapsed = Math.floor((Date.now() - startTime) / 1000);
					const timerEl = document.getElementById("timer");
					timerEl.textContent = elapsed + "s";

					// Warning color after 30 seconds
					if (elapsed >= 30) {
						timerEl.classList.add("warning");
					}
				}, 1000);
			}

			// Load question
			async function loadQuestion() {
				try {
					const response = await fetch("/api/questions");
					if (!response.ok)
						throw new Error("Failed to load question");

					currentQuestion = await response.json();
					displayQuestion(currentQuestion);
					startTimer();
				} catch (error) {
					showError(
						"Failed to load question. Please refresh the page."
					);
					console.error(error);
				}
			}

			// Display question
			function displayQuestion(question) {
				document.getElementById("questionText").textContent =
					question.questionText;

				const optionsContainer =
					document.getElementById("optionsContainer");
				optionsContainer.innerHTML = "";

				question.options.forEach((option, index) => {
					const optionEl = document.createElement("div");
					optionEl.className = "option";
					optionEl.innerHTML = `
                    <span class="option-label">${String.fromCharCode(
						65 + index
					)}</span>
                    <span>${option}</span>
                `;

					optionEl.addEventListener("click", () =>
						selectOption(option, optionEl)
					);
					optionsContainer.appendChild(optionEl);
				});
			}

			// Select option
			function selectOption(answer, element) {
				selectedAnswer = answer;

				// Remove selected class from all options
				document.querySelectorAll(".option").forEach(opt => {
					opt.classList.remove("selected");
				});

				// Add selected class to clicked option
				element.classList.add("selected");

				// Enable submit button
				const submitBtn = document.getElementById("submitBtn");
				submitBtn.disabled = false;
				submitBtn.textContent = "Submit Answer";
			}

			// Submit answer
			async function submitAnswer() {
				if (!selectedAnswer) return;

				clearInterval(timerInterval);
				const duration = Math.floor((Date.now() - startTime) / 1000);

				// Show loading
				document.getElementById("submitBtn").style.display = "none";
				document.getElementById("loading").style.display = "block";

				try {
					const response = await fetch("/api/submit", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify({
							studentName: studentName,
							questionId: currentQuestion.id || 1,
							answer: selectedAnswer,
							duration: duration,
						}),
					});

					if (!response.ok)
						throw new Error("Failed to submit answer");

					const result = await response.json();

					// Redirect to results/leaderboard
					window.location.href = "/leaderboard";
				} catch (error) {
					showError("Failed to submit answer. Please try again.");
					console.error(error);
					document.getElementById("submitBtn").style.display =
						"block";
					document.getElementById("loading").style.display = "none";
					startTimer(); // Restart timer
				}
			}

			// Show error
			function showError(message) {
				const errorEl = document.getElementById("error");
				errorEl.textContent = message;
				errorEl.style.display = "block";
			}

			// Event listeners
			document
				.getElementById("submitBtn")
				.addEventListener("click", submitAnswer);

			// Keyboard shortcuts
			document.addEventListener("keydown", e => {
				const key = e.key.toUpperCase();
				const options = document.querySelectorAll(".option");

				// A, B, C, D keys
				if (key >= "A" && key <= "D") {
					const index = key.charCodeAt(0) - 65;
					if (options[index]) {
						options[index].click();
					}
				}

				// Enter to submit
				if (e.key === "Enter" && selectedAnswer) {
					submitAnswer();
				}
			});

			// Load question on page load
			loadQuestion();
		</script>
	</body>
</html>
