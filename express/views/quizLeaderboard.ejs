<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Quiz Leaderboard - <%= title %></title>
		<link rel="stylesheet" href="/style.css" />
		<style>
			* {
				box-sizing: border-box;
			}
			body {
				overflow-x: hidden;
			}
			h1 {
				font-size: 1.8rem;
				margin-bottom: 5px;
			}
			.quiz-name {
				text-align: center;
				color: #715a5a;
				margin-bottom: 20px;
			}
			.stats {
				display: flex;
				gap: 10px;
				background: white;
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 20px;
				text-align: center;
			}
			.stat {
				flex: 1;
			}
			.stat-value {
				font-size: 1.8rem;
				font-weight: bold;
				color: #715a5a;
			}
			.stat-label {
				font-size: 0.85rem;
				color: #666;
			}
			.table-wrapper {
				width: 100%;
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
				cursor: default;
			}
			table {
				width: 100%;
				min-width: 550px;
				border-collapse: collapse;
				background: white;
				border-radius: 8px;
				overflow: hidden;
				user-select: none;
			}
			thead {
				background: #715a5a;
				color: white;
			}
			th,
			td {
				padding: 12px 8px;
				text-align: left;
				font-size: 0.9rem;
			}
			th {
				font-weight: bold;
			}
			tbody tr {
				border-bottom: 1px solid #e0e0e0;
			}
			tbody tr:last-child {
				border-bottom: none;
			}
			tbody tr:hover {
				background: #f5f5f5;
			}
			.rank {
				font-weight: bold;
				color: #715a5a;
				font-size: 1.2rem;
				width: 50px;
				text-align: center;
			}
			.score {
				color: #4caf50;
				font-weight: bold;
			}
			.loading,
			.empty {
				text-align: center;
				padding: 40px 20px;
				color: #715a5a;
			}
			button {
				margin-top: 30px;
			}

			@media (max-width: 600px) {
				main {
					padding: 20px;
				}
				h1 {
					font-size: 1.5rem;
				}
				.quiz-name {
					font-size: 1rem;
				}
				.stats {
					padding: 12px 8px;
				}
				.stat-value {
					font-size: 1.5rem;
				}
				.stat-label {
					font-size: 0.75rem;
				}
				th,
				td {
					padding: 10px 6px;
					font-size: 0.85rem;
				}
				.rank {
					font-size: 1rem;
				}
			}
		</style>
	</head>
	<body>
		<main>
			<h1>Quiz Leaderboard</h1>
			<div class="quiz-name" id="quizName">Loading...</div>

			<div class="loading" id="loading">Loading...</div>
			<div class="empty" id="empty" style="display: none">
				No submissions yet. Be the first!
			</div>

			<div id="content" style="display: none">
				<div class="stats" id="stats" style="display: none">
					<div class="stat">
						<div class="stat-value" id="participants">0</div>
						<div class="stat-label">Participants</div>
					</div>
					<div class="stat">
						<div class="stat-value" id="avg">0</div>
						<div class="stat-label">Avg Score</div>
					</div>
					<div class="stat">
						<div class="stat-value" id="passed">0</div>
						<div class="stat-label">Passed (60%)</div>
					</div>
				</div>

				<div class="table-wrapper">
					<table>
						<thead>
							<tr>
								<th>Rank</th>
								<th>Student</th>
								<th>Score</th>
								<th>Questions</th>
								<th>Time</th>
							</tr>
						</thead>
						<tbody id="tbody"></tbody>
					</table>
				</div>
			</div>

			<button onclick="location.href='/'">Home</button>
		</main>

		<script>
			const quizId = parseInt("<%= quizId %>");

			async function load() {
				try {
					const res = await fetch(
						`/api/quizzes/${quizId}/leaderboard`
					);
					if (!res.ok) throw new Error("Failed");
					const data = await res.json();

					// Get quiz name
					try {
						const qRes = await fetch("/api/quizzes");
						const quizzes = await qRes.json();
						const quiz = quizzes.find(q => q.id === quizId);
						if (quiz)
							document.getElementById("quizName").textContent =
								quiz.title;
					} catch (e) {
						document.getElementById("quizName").textContent =
							"Quiz Results";
					}

					document.getElementById("loading").style.display = "none";

					if (!data.length) {
						document.getElementById("empty").style.display =
							"block";
						return;
					}

					document.getElementById("content").style.display = "block";

					// Stats
					const scores = data.map(d => d.total_score);
					const maxScore = data[0].questions_answered * 10; // 10 points per question
					const passingScore = maxScore * 0.6;
					const passedCount = scores.filter(
						s => s >= passingScore
					).length;

					document.getElementById("participants").textContent =
						data.length;
					document.getElementById("avg").textContent = Math.round(
						scores.reduce((a, b) => a + b) / data.length
					);
					document.getElementById("passed").textContent = passedCount;
					document.getElementById("stats").style.display = "flex";

					// Sort
					data.sort((a, b) =>
						b.total_score !== a.total_score
							? b.total_score - a.total_score
							: a.total_duration - b.total_duration
					);

					// Table
					const tbody = document.getElementById("tbody");
					data.forEach((e, i) => {
						const medal =
							i === 0
								? "ðŸ¥‡"
								: i === 1
								? "ðŸ¥ˆ"
								: i === 2
								? "ðŸ¥‰"
								: i + 1;

						tbody.innerHTML += `
							<tr>
								<td class="rank">${medal}</td>
								<td><strong>${escape(e.student_name)}</strong></td>
								<td class="score">${e.total_score}</td>
								<td>${e.questions_answered} answered</td>
								<td>${e.total_duration}s</td>
							</tr>
						`;
					});
				} catch (err) {
					document.getElementById("loading").textContent =
						"Failed to load";
				}
			}

			function escape(text) {
				const div = document.createElement("div");
				div.textContent = text;
				return div.innerHTML;
			}

			load();
		</script>
	</body>
</html>
